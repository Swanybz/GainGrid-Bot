<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Prevent mobile zooming / make it act like an app -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no,address=no,email=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>GainGrid IP Verification</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    /* preserve UI but ensure no zoom & full-screen behavior */
    html, body { height: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 16px; /* >=16px prevents browser auto-zoom on focus */
      background: linear-gradient(135deg,#0b0b0f 0%,#0f0226 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      touch-action: manipulation; /* prevent double-tap zoom gestures */
      -ms-touch-action: manipulation;
      overscroll-behavior: contain;
    }

    .app-container {
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background .6s ease;
    }
    .app-container.scanning { background: linear-gradient(135deg,#7D00FF 0%,#FF0040 50%,#FF79B0 100%); }
    .app-container.approved { background: linear-gradient(135deg,#7D00FF 0%,#00FFF0 100%); }
    .app-container.rejected { background: linear-gradient(135deg,#4a0040 0%,#8B0000 50%,#FF0040 100%); animation: pulse-background 2s infinite; }
    @keyframes pulse-background {0%,100%{opacity:1}50%{opacity:.92}}

    .glass-card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 28px;
      max-width: 720px;
      width: 100%;
      max-height: calc(100vh - 40px);
      box-shadow: 0 10px 40px rgba(0,0,0,.5);
      position: relative;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .glass-card.shimmer::before {
      content: '';
      position: absolute;
      left: -100%;
      top: 0;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent 45%, rgba(255,255,255,0.03) 50%, transparent 55%);
      animation: shimmer 2.2s linear infinite;
      pointer-events: none;
    }
    @keyframes shimmer { 0%{left:-100%}100%{left:100%} }

    .state-section { display: none; animation: fadeIn .45s ease both; }
    .state-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* header + visual */
    .header { text-align: center; margin-bottom: 16px; }
    .app-title { font-size: 22px; font-weight: 700; color: #ffffff; margin-bottom: 6px; }
    .scan-message { font-size: 14px; color: rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; gap:8px; }
    .shield-icon { width:72px; height:72px; margin:10px auto; display:flex; align-items:center; justify-content:center; }
    .rotating { animation: rotate 2.4s linear infinite; }
    @keyframes rotate { from { transform: rotate(0); } to { transform: rotate(360deg); } }

    .ip-display { background: rgba(0,0,0,.34); border-radius: 12px; padding: 12px; margin: 18px 0; text-align:center; border: 1px solid rgba(0,255,240,.06); }
    .ip-label { font-size: 11px; color: rgba(255,255,255,.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .ip-value { font-size: 20px; font-weight: 700; color: #00FFF0; font-family: 'Courier New', monospace; text-shadow: 0 0 8px rgba(0,255,240,.12); }
    .scanning-bar { width:100%; height:6px; background: rgba(255,255,255,.04); border-radius: 4px; overflow: hidden; margin-top: 12px; }
    .scanning-progress { height:100%; width:0%; background: linear-gradient(90deg,#7D00FF,#00FFF0,#FF79B0); box-shadow: 0 0 16px rgba(0,255,240,.08); transition: width 600ms linear; }

    /* approved/rejected visuals */
    .status-icon { width:96px; height:96px; margin: 12px auto; }
    .status-title { font-size: 26px; font-weight:700; color:#fff; text-align:center; margin-bottom:6px; }
    .status-subtitle { font-size: 14px; color: rgba(255,255,255,.95); text-align:center; margin-bottom:12px; line-height:1.45; }
    .profile-section { display:flex; align-items:center; gap:12px; background: rgba(0,0,0,.25); border-radius:10px; padding:12px; margin:12px 0; }
    .profile-avatar { width:52px; height:52px; border-radius:50%; background: linear-gradient(135deg,#7D00FF,#00FFF0); display:flex; align-items:center; justify-content:center; font-size:20px; color:#fff; font-weight:700; }
    .profile-name { font-size: 15px; font-weight: 600; color: #fff; }
    .info-note { background: rgba(0,255,240,.06); border-left: 3px solid #00FFF0; border-radius:8px; padding:12px; margin:12px 0; font-size:13px; color:rgba(255,255,255,.95); }

    .error-details { background: rgba(0,0,0,.32); border-radius:10px; padding:12px; margin-bottom:12px; border:1px solid rgba(255,0,64,.08); }
    .error-row { display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; }
    .error-label { color: rgba(255,255,255,.75); }
    .error-value { color: #FF0040; font-weight:600; font-family:'Courier New', monospace; }

    .action-button { width:100%; padding:14px; border:none; border-radius:10px; font-size:14px; font-weight:700; cursor:pointer; transition: all .18s ease; text-transform:uppercase; letter-spacing:.6px; position:relative; overflow:hidden; }
    .btn-primary { background: linear-gradient(135deg,#7D00FF,#00FFF0); color:#fff; box-shadow: 0 6px 26px rgba(0,255,240,.06); }
    .btn-secondary { background: rgba(255,255,255,.06); color:#fff; border:1px solid rgba(255,255,255,.04); margin-top:8px; }

    .confetti { position:absolute; width:10px; height:10px; background:#00FFF0; animation: confetti-fall 3s ease-out forwards; }
    @keyframes confetti-fall { 0% { transform: translateY(0) rotate(0); opacity:1 } 100% { transform: translateY(500px) rotate(720deg); opacity:0 } }

    /* make glass-card safe on very tall screens */
    @media (min-height: 900px) { .glass-card { max-height: calc(100vh - 40px); overflow:auto; } }
    @media (max-width: 520px) { .glass-card { padding:18px; border-radius:14px; } .app-title { font-size:20px; } .ip-value { font-size:18px; } .status-title { font-size:22px; } }
  </style>
</head>
<body>
  <div class="app-container scanning" id="appContainer" role="main" aria-live="polite">
    <div class="glass-card shimmer" id="glassCard">
      <!-- Scanning State -->
      <div class="state-section active" id="scanningState">
        <div class="header">
          <h1 class="app-title" id="appTitle">GainGrid¬Æ Security Protocol</h1>
          <p class="scan-message" id="scanMessage">üîê <span>Verifying session with Grid AI...</span></p>
        </div>

        <div class="shield-icon rotating" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" width="72" height="72" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L3 6V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V6L12 2Z"
              stroke="#00FFF0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="rgba(0,255,240,0.08)"/>
          </svg>
        </div>

        <div class="ip-display" aria-hidden="false">
          <div class="ip-label">Checking IP Address</div>
          <div class="ip-value" id="scanningIP">Loading...</div>
        </div>

        <div class="scanning-bar" aria-hidden="true">
          <div class="scanning-progress" id="scanningProgress"></div>
        </div>
      </div>

      <!-- Approved State -->
      <div class="state-section" id="approvedState" aria-hidden="true">
        <div class="status-icon">
          <svg class="checkmark" viewBox="0 0 24 24" width="96" height="96" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="#00FFF0" stroke-width="2" fill="rgba(0,255,240,0.06)"/>
            <path d="M8 12L11 15L16 9" stroke="#00FFF0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <h2 class="status-title" id="approvedTitle">‚úÖ Verified Successfully</h2>
        <p class="status-subtitle" id="approvedSubtitle">Welcome back! Your session has been approved by Grid AI.</p>

        <div class="profile-section" role="region" aria-label="User profile">
          <div class="profile-avatar" id="userAvatar">U</div>
          <div class="profile-info">
            <div class="profile-name" id="userName">Telegram User</div>
            <div class="profile-status">Session Active</div>
          </div>
        </div>

        <div class="info-note" id="approvedNote">Connected via secure network. Your IP is safe.</div>

        <button class="action-button btn-primary" id="continueButton"> Continue to Dashboard </button>
      </div>

      <!-- Rejected State -->
      <div class="state-section" id="rejectedState" aria-hidden="true">
        <div class="status-icon">
          <svg class="error-icon" viewBox="0 0 24 24" width="96" height="96" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="#FF0040" stroke-width="2" fill="rgba(255,0,64,0.06)"/>
            <path d="M15 9L9 15M9 9L15 15" stroke="#FF0040" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>

        <h2 class="status-title" id="rejectedTitle">üö´ Multiple Accounts Detected</h2>
        <p class="status-subtitle" id="rejectedSubtitle">This device already has a verified primary account stored.</p>

        <div class="error-details">
          <div class="error-row"><span class="error-label">Stored IP:</span> <span class="error-value" id="rejectedIP">‚Äî</span></div>
          <div class="error-row"><span class="error-label">Reason:</span> <span class="error-value" id="rejectedReason">‚Äî</span></div>
        </div>

        <div class="info-note" id="rejectedSuggestion">If this is unexpected, contact support or use the primary account to continue.</div>

        <button class="action-button btn-primary" id="supportButton"> üîß Contact Support </button>
        <button class="action-button btn-secondary" id="retryButton"> Try Again </button>
      </div>

    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // Use your exact storage key as before
    const STORAGE_KEY = '<% bot.id %>telegramProfile';
    const scanningIPEl = document.getElementById('scanningIP');
    const scanningProgress = document.getElementById('scanningProgress');
    const appContainer = document.getElementById('appContainer');
    const glassCard = document.getElementById('glassCard');

    const defaultConfig = {
      rejected_reason: "Suspicious VPN usage or duplicate session"
    };

    // small deterministic local IP "generator" (no external calls)
    function generateLocalIP() {
      // deterministic pseudo-random tied to day/time to feel real but not external
      const now = Date.now();
      const a = (Math.floor(now / 1000) % 253) + 1;
      const b = (Math.floor(now / 3000) % 253) + 1;
      const c = (Math.floor(now / 7000) % 253) + 1;
      const d = (Math.floor(now / 11000) % 253) + 1;
      return `${a}.${b}.${c}.${d}`;
    }

    // fallback random generator (used rarely)
    function generateRandomIP() {
      return `${Math.floor(Math.random()*254)+1}.${Math.floor(Math.random()*254)+1}.${Math.floor(Math.random()*254)+1}.${Math.floor(Math.random()*254)+1}`;
    }

    // Read and write localStorage
    function readStoredProfile(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn('Failed reading stored profile, purging', e);
        try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
        return null;
      }
    }
    function storeProfile(profile) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(profile)); }
      catch(e){ console.error('store failed', e); }
    }

    // small token for payload
    function smallToken(obj) {
      try {
        const txt = JSON.stringify(obj);
        let h = 2166136261 >>> 0;
        for (let i=0;i<txt.length;i++){ h = Math.imul(h ^ txt.charCodeAt(i), 16777619) >>> 0; }
        return ('T'+h.toString(36)).toUpperCase();
      } catch(e){ return Date.now().toString(36); }
    }

    // Use hook query param provided by your bot (Libs.Webhooks.getUrlFor returned value)
    function getHookUrl() {
      try {
        const u = new URL(window.location.href);
        return u.searchParams.get('hook') || u.searchParams.get('webhook') || '';
      } catch (e) { return ''; }
    }
    const hookUrl = getHookUrl();

    // Guaranteed immediate webhook send for each validation
    async function sendWebhookToBot(userData, isPrimary) {
      const payload = {
        userId: userData.userId,
        username: userData.username || '',
        firstName: userData.firstName || '',
        lastName: userData.lastName || '',
        isPrimary: !!isPrimary,
        ip: userData.ip || null,
        timestamp: new Date().toISOString(),
        token: smallToken({uid:userData.userId,ip:userData.ip,ts:Date.now()})
      };

      console.log('Attempting webhook POST to', hookUrl, 'payload', payload);

      // small UX delay to keep animation feeling high-quality
      await new Promise(r=>setTimeout(r, 420));

      if (!hookUrl) {
        console.warn('No hook provided in URL ‚Äî webhook simulated.');
        return { ok:true, simulated:true };
      }

      try {
        const resp = await fetch(hookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          cache: 'no-store'
        });
        if (!resp.ok) {
          const text = await resp.text().catch(()=>null);
          console.error('Webhook returned error', resp.status, text);
          return { ok:false, status:resp.status, text };
        }
        console.log('Webhook sent ok');
        return { ok:true };
      } catch (err) {
        console.error('Webhook send error', err);
        return { ok:false, error: String(err) };
      }
    }

    // UI state control
    function setActiveState(state) {
      document.querySelectorAll('.state-section').forEach(s => s.classList.remove('active'));
      appContainer.className = `app-container ${state}`;
      if (state === 'scanning') {
        document.getElementById('scanningState').classList.add('active');
        glassCard.classList.add('shimmer');
        scanningProgress.style.width = '0%';
        setTimeout(()=> scanningProgress.style.width = '26%', 70);
        setTimeout(()=> scanningProgress.style.width = '56%', 900);
        setTimeout(()=> scanningProgress.style.width = '84%', 2100);
      } else if (state === 'approved') {
        document.getElementById('approvedState').classList.add('active');
        glassCard.classList.remove('shimmer');
        scanningProgress.style.width = '100%';
        runCelebration();
      } else if (state === 'rejected') {
        document.getElementById('rejectedState').classList.add('active');
        glassCard.classList.remove('shimmer');
        scanningProgress.style.width = '100%';
        // shake effect comes from CSS already
      }
    }

    // celebration shapes + confetti
    function runCelebration(){
      // falling confetti
      const colors = ['#7D00FF','#FF0040','#FF79B0','#00FFF0'];
      for (let i=0;i<40;i++){
        setTimeout(()=>{
          const el = document.createElement('div');
          el.className = 'confetti';
          el.style.left = (Math.random()*94 + 2) + '%';
          const s = Math.random()*10 + 8;
          el.style.width = s+'px';
          el.style.height = s+'px';
          el.style.background = colors[Math.floor(Math.random()*colors.length)];
          el.style.transform = `rotate(${Math.random()*360}deg)`;
          document.getElementById('appContainer').appendChild(el);
          setTimeout(()=> el.remove(), 3600);
        }, i * 40);
      }

      // celebratory shapes that float then disappear
      for (let i=0;i<8;i++){
        setTimeout(()=>{
          const shape = document.createElement('div');
          shape.style.position='absolute';
          shape.style.width='18px';
          shape.style.height='18px';
          shape.style.left = (20 + Math.random()*60) + '%';
          shape.style.top = (20 + Math.random()*10) + '%';
          shape.style.borderRadius = (Math.random()>.5 ? '50%' : '6px');
          shape.style.background = colors[Math.floor(Math.random()*colors.length)];
          shape.style.opacity = '0.95';
          shape.style.pointerEvents = 'none';
          shape.style.transform = `translateY(0) scale(1)`;
          shape.style.transition = 'transform 1.6s cubic-bezier(.22,.9,.23,1), opacity 1.6s linear';
          document.getElementById('appContainer').appendChild(shape);
          requestAnimationFrame(()=> {
            shape.style.transform = 'translateY(220px) scale(1.6)';
            shape.style.opacity = '0';
          });
          setTimeout(()=> shape.remove(), 1800);
        }, 240 + i*140);
      }
    }

    function showVerifiedScreen(profile){
      document.getElementById('userName').textContent = profile.firstName || 'Telegram User';
      document.getElementById('userAvatar').textContent = (profile.firstName || 'U')[0].toUpperCase();
      document.getElementById('approvedNote').textContent = `Connected via secure network. Your IP: ${profile.ip || '‚Äî'}`;
      setActiveState('approved');
    }

    function showRejectedScreen(stored, reason){
      document.getElementById('rejectedIP').textContent = stored.ip || '‚Äî';
      document.getElementById('rejectedReason').textContent = reason || defaultConfig.rejected_reason;
      setActiveState('rejected');
    }

    // main flow (no external IP calls)
    async function mainFlow(){
      setActiveState('scanning');
      await new Promise(r => setTimeout(r, 320)); // allow initial animation

      // detect Telegram webapp and user
      let isTelegram = false;
      let telegramUser = null;
      let currentUserId = null;
      try {
        if (window.Telegram && window.Telegram.WebApp) {
          isTelegram = true;
          const tg = window.Telegram.WebApp;
          tg.ready && tg.ready();
          tg.expand && tg.expand();
          telegramUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
          currentUserId = telegramUser && telegramUser.id ? telegramUser.id : null;
          if (telegramUser && telegramUser.first_name) {
            document.getElementById('userName').textContent = telegramUser.first_name;
            document.getElementById('userAvatar').textContent = (telegramUser.first_name || 'U')[0].toUpperCase();
          }
        } else {
          isTelegram = false;
          currentUserId = Math.floor(Math.random()*1000000000);
        }
      } catch (e) {
        console.warn('telegram detect fail', e);
        isTelegram = false;
        currentUserId = Math.floor(Math.random()*1000000000);
      }

      // use deterministic local IP generator (no external network)
      let ip;
      try {
        // primary deterministic local IP
        ip = generateLocalIP();
        // sanity: if somehow invalid fallback to random
        if (!ip || ip.split('.').length !== 4) ip = generateRandomIP();
      } catch(e) {
        ip = generateRandomIP();
      }

      scanningIPEl.textContent = ip;

      // assemble userData
      const userData = (isTelegram && telegramUser) ? {
        userId: telegramUser.id,
        username: telegramUser.username || 'Not set',
        firstName: telegramUser.first_name || '',
        lastName: telegramUser.last_name || '',
        isTelegram: true,
        ip,
        timestamp: new Date().toISOString()
      } : {
        userId: currentUserId,
        username: '@user_' + Math.floor(Math.random()*10000),
        firstName: 'User',
        lastName: 'Account',
        isTelegram: false,
        ip,
        timestamp: new Date().toISOString()
      };

      // check localStorage
      const existingProfile = readStoredProfile();

      if (existingProfile) {
        if (existingProfile.userId === userData.userId) {
          // same user: verified primary
          showVerifiedScreen(existingProfile);
          // send primary webhook immediately (on-load)
          await sendWebhookToBot(existingProfile, true);
        } else {
          // different user: blocked / multiple accounts
          showRejectedScreen(existingProfile, defaultConfig.rejected_reason);
          // send secondary webhook with existing profile immediately
          await sendWebhookToBot(existingProfile, false);
        }
      } else {
        // no existing profile: store current as primary
        storeProfile(userData);
        showVerifiedScreen(userData);
        // send primary webhook immediately
        await sendWebhookToBot(userData, true);
      }
    }

    // hook up buttons
    document.getElementById('retryButton').addEventListener('click', async function(){
      setActiveState('scanning');
      await new Promise(r=>setTimeout(r,200));
      mainFlow();
    });
    document.getElementById('supportButton').addEventListener('click', function(){
      window.open('https://t.me/swanyTech','_blank','noopener,noreferrer');
    });
    document.getElementById('continueButton').addEventListener('click', function(){
      if (window.Telegram && window.Telegram.WebApp) {
        try { window.Telegram.WebApp.close(); } catch(e) { console.warn(e); }
      } else {
        alert('Verification complete (demo).');
      }
    });

    // small inline verify via tapping the IP (keeps consistent behavior)
    scanningIPEl.addEventListener('click', async function(){
      // transient verify button appended below ip if user taps
      if (document.getElementById('transientVerifyBtn')) return;
      const ipDisplay = scanningIPEl.parentNode;
      const btn = document.createElement('button');
      btn.id = 'transientVerifyBtn';
      btn.className = 'action-button btn-primary';
      btn.style.marginTop = '10px';
      btn.textContent = 'Verify Now';
      ipDisplay.appendChild(btn);
      btn.addEventListener('click', async function() {
        btn.disabled = true;
        btn.textContent = 'Verifying...';
        // re-run minimal verification
        const ipNow = generateLocalIP();
        scanningIPEl.textContent = ipNow;
        let telegramUser = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) ? window.Telegram.WebApp.initDataUnsafe.user : null;
        const user = telegramUser ? {
          userId: telegramUser.id,
          username: telegramUser.username || '',
          firstName: telegramUser.first_name || '',
          lastName: telegramUser.last_name || '',
          ip: ipNow,
          timestamp: new Date().toISOString()
        } : {
          userId: Math.floor(Math.random()*1000000000),
          username: '@user_' + Math.floor(Math.random()*10000),
          firstName: 'User',
          lastName: '',
          ip: ipNow,
          timestamp: new Date().toISOString()
        };

        const existing = readStoredProfile();
        if (!existing) {
          storeProfile(user);
          showVerifiedScreen(user);
          await sendWebhookToBot(user, true);
        } else if (existing.userId === user.userId) {
          showVerifiedScreen(existing);
          await sendWebhookToBot(existing, true);
        } else {
          showRejectedScreen(existing, defaultConfig.rejected_reason);
          await sendWebhookToBot(existing, false);
        }
        btn.remove();
      });
    });

    // elementSdk integration preserved (live config)
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: { approved_note: "Connected via secure network. Your IP is safe.", rejected_reason: defaultConfig.rejected_reason },
        onConfigChange: (cfg) => {
          try {
            document.getElementById('appTitle').textContent = cfg.app_title || document.getElementById('appTitle').textContent;
            const span = document.getElementById('scanMessage').querySelector('span');
            if (span) span.textContent = cfg.scan_message || span.textContent;
            document.getElementById('approvedTitle').textContent = `‚úÖ ${cfg.approved_title || 'Verified Successfully'}`;
            document.getElementById('approvedSubtitle').textContent = cfg.approved_subtitle || document.getElementById('approvedSubtitle').textContent;
            document.getElementById('approvedNote').textContent = cfg.approved_note || document.getElementById('approvedNote').textContent;
            document.getElementById('continueButton').textContent = cfg.approved_button || document.getElementById('continueButton').textContent;
            document.getElementById('rejectedTitle').textContent = `üö´ ${cfg.rejected_title || 'Access Blocked'}`;
            document.getElementById('rejectedSubtitle').textContent = cfg.rejected_subtitle || document.getElementById('rejectedSubtitle').textContent;
            document.getElementById('supportButton').textContent = `üîß ${cfg.support_button || 'Contact Support'}`;
          } catch (e) { console.warn('elementSdk apply failed', e); }
        },
        mapToCapabilities: ()=>({ recolorables:[], borderables:[], fontEditable:undefined, fontSizeable:undefined }),
        mapToEditPanelValues: (config)=>new Map([['app_title', config.app_title || 'GainGrid¬Æ Security Protocol']])
      });
    }

    // initial run
    mainFlow();

  })();
  </script>
</body>
</html>